```{r}
source("Rscripts/utils.R")
source("Rscripts/Fire-peak-df.R")
```

```{r}
vcf="/mmfs1/gscratch/stergachislab/mvollger/projects/k-mer-variant-phasing/results/GM12878/hiphase/GM12878.vcf.gz"
vcf_df = fread(cmd=glue("bcftools view -f 'PASS' -i 'GT=\"HET\"' {vcf} | grep -v ^##"))
imprinted=my_read_bed("data/lcl_dmr_coordinates_Akbari.bed.gz")
```

```{r}
vcf_df = vcf_df %>% 
    mutate(start = POS-1) %>%
    rename(
        chrom="#CHROM",
        end=POS
    )
vcf_df
nrow(vcf_df)/1e6

hap_peaks=my_read_bed("results/GM12878/hap1-vs-hap2/FIRE.hap.differences.bed") %>%
    filter(p_adjust<=0.05 & autosome=="Autosome" ) %>%
    data.table

mean(hap_peaks$end-hap_peaks$start)
mean(vcf_df$end-vcf_df$start)

hap_peaks %>%
    select(-start.other, end.other) %>%
    bed_map(vcf_df,
        n_variants = n(),
    ) %>% 
    bed_map(imprinted,
        imprinted = "imprinted"
    ) %>%
    replace_na(list(
        n_variants=0,
        imprinted="not-imprinted"
    )) %>%
    ggplot(
        aes(
            x=pmin(n_variants, 10),
        )
    ) +
    geom_histogram(
        aes(fill=imprinted),
        binwidth=1,
        #color="black",
        width=0.4,
    ) +
    stat_bin(
        aes(
            y = after_stat(count),
            label=ifelse(..count.. > 0, ..count.., ""),
            #after_stat(count),
            fill=imprinted,
        ),
        color="black",
        vjust=1,
        binwidth=1,
        geom="text_repel",
        min.segment.length=unit(1000, "lines"),
        direction="y",
        size=1.5,
    ) +
    scale_x_continuous(
        glue("Number of heterozygous genetic variants per haplotype-specific peak\n(n={nrow(hap_peaks)} autosomal peaks)"),
        breaks=seq(0,10),
        labels=c(seq(0,9), "10+")
    ) +
    scale_y_continuous("Number of peaks") +
    my_hgrid() +
    scale_fill_manual("",
        values=c("imprinted"="darkorange","not-imprinted"="darkgrey")
    ) +
    theme(
        legend.position="top",
    ) 

my_ggsave("Figures/n-variants-per-hap-peak.pdf", height=3, width=3)
```
