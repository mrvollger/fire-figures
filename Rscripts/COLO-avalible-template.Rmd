---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
# get a fire peak data table called `df`
source("Rscripts/utils.R")
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}
library(rlang)
#library(gmm)
# Load the package
library(mclust)

all_covs = fread("results/PS00357_COLO829T_1/FDR-peaks/FDR.track.bed.gz") %>%
    # require 95% phasing
    filter(
        `#chrom` != "chrX",
        `#chrom` != "chrY",
    ) %>%
    filter(coverage * 0.95 <= coverage_H1 + coverage_H2) %>%
    filter(
        pmin(coverage_H1, coverage_H2) > 1,
    ) %>%
    sample_n(1e6)
model_cov = all_covs %>% filter(
    coverage < 200,
    coverage > 30
)

pdf("tmp.pdf")
hist(model_cov$coverage_H1, breaks=100, xlim=c(0,100))
hist(model_cov$coverage_H2, breaks=100, col="red", xlim=c(0,100))
hist(model_cov$coverage, breaks=100, col="blue", xlim=c(0,100))
hist(model_cov$coverage_H1 + model_cov$coverage_H2, breaks=100, col="blue", xlim=c(0,100))
dev.off()
nrow(fire)

m = Mclust(c(model_cov$coverage_H1, model_cov$coverage_H2), G=seq(2))
m$parameters$mean

```

```{r}
sd_range = 2
# Tumor PS00357
fire = fread("results/PS00357_COLO829T_1/FDR-peaks/FDR-FIRE-peaks.bed.gz") %>%
    # require 95% phasing
    filter(
        `#chrom` != "chrX",
        `#chrom` != "chrY",
    ) %>%
    filter(coverage * 0.95 <= coverage_H1 + coverage_H2) %>%
    filter(
        pmin(coverage_H1, coverage_H2) > 1,
    )

# make H1 the hap with more coverage always
fire$swap = fire$coverage_H1 > fire$coverage_H2 
#tmp[R2 == val, c("R1", "R2") := .(R2, R1)]
fire[swap==TRUE, c("coverage_H1", "coverage_H2") := .(coverage_H2, coverage_H1)]
fire[swap==TRUE, c("fire_coverage_H1", "fire_coverage_H2") := .(fire_coverage_H2, fire_coverage_H1)]

fire$class_H1 = predict(m, fire$coverage_H1)$classification
fire$class_H2 = predict(m, fire$coverage_H2)$classification
table(fire$class_H1)
table(fire$class_H2)

norm_vs_dup_df_wide = fire %>% 
    filter(coverage_H2 >=coverage_H1) %>%
    mutate(
        is_dup=(class_H1 == 1 & class_H2==2),
    ) %>%
    mutate(
        percent_accessible_dup = 100*fire_coverage_H2 / coverage_H2,
        percent_accessible_norm = 100*fire_coverage_H1 / coverage_H1,
    ) %>%
    mutate(
        norm_minus_dup = percent_accessible_norm - percent_accessible_dup 
    )

norm_vs_dup_df = norm_vs_dup_df_wide %>%
    pivot_longer(
        cols = c("percent_accessible_dup", "percent_accessible_norm"),
        names_to = "type",
        values_to = "percent"
    )

norm_vs_dup_df_coverage = norm_vs_dup_df_wide %>%
    pivot_longer(
        cols = c("coverage_H1", "coverage_H2"),
        names_to = "type",
        values_to = "coverage_hap"
    )

table(norm_vs_dup_df_wide$is_dup)
```

```{r}
norm_vs_dup_df %>%
    filter(is_dup) %>%
    ggplot(aes(fill=type, x=percent)) +
    #geom_histogram(binwidth=2, position="identity", alpha=0.7) +
    geom_density(alpha=0.7) +
    scale_fill_manual("",
        labels=rev(c("Duplicated haplotype", "Normal haplotype")),
        values=rev(c("darkred", "skyblue")),
    ) +
    scale_x_continuous("Percent accessible", limits=c(0, 100)) +
    theme_minimal_grid() +
    theme(legend.position="top")
my_ggsave("Figures/COLO-available-template.pdf") 

norm_vs_dup_df_wide %>%
    ggplot(aes(x=norm_minus_dup, fill=is_dup)) + 
    geom_density(alpha=0.4, aes(y = after_stat(scaled))) +
    scale_x_continuous("Percent accessible (normal - duplicated)", limits=c(-100,100)) +
    theme_minimal_grid() +
    #facet_col(~is_dup)+
    scale_fill_manual("",
        labels=c("Regions with normal coverage", "Regions with one duplicated haplotype"),
        values=c("skyblue", "darkred"),
    ) +
    theme(legend.position="top")
my_ggsave("Figures/COLO-available-template-diff.pdf")


# plot the coverage of the duplicated haplotype vs the normal haplotype
norm_vs_dup_df_coverage %>%
    #filter(is_dup) %>%
    ggplot(aes(fill=type, x=coverage_hap)) +
    geom_density(
        #aes(y = after_stat(scaled)),
        alpha=0.75, adjust=0.3
    ) +
    scale_fill_manual("",
        labels=rev(c("Duplicated haplotype", "Normal haplotype")),
        values=rev(c("darkred", "skyblue")),
    ) +
    scale_x_continuous("Coverage", limits=c(0,100), breaks=seq(0,100,25)) +
    theme_minimal_grid() +
    facet_col(~is_dup) + 
    theme(legend.position="top")
my_ggsave("Figures/COLO-available-template-total-coverage.pdf") 

```


```{r}
median(norm_vs_dup_df_wide$coverage_H1)
median(norm_vs_dup_df_wide$coverage_H2)
median(norm_vs_dup_df_wide[is_dup==TRUE]$coverage_H1)
```


```{r}
pdf("tmp.pdf")
hist(
    fire[coverage<200]$coverage_H2, breaks=100
    )
dev.off()

getmode(fire$coverage_H1)
getmode(fire$coverage_H2)
```



```{r}
# PS00338_DSA.asm.phased.bed.gz
# PS00338_GRCh38.bed.gz
# PS00357_DSA.asm.phased.bed.gz
# PS00357_GRCh38.bed.gz
a=fread("COLO-asm/stats/PS00338_GRCh38.bed.gz")
b=fread("COLO-asm/stats/PS00338_DSA.asm.phased.bed.gz")
c=fread("COLO-asm/stats/PS00357_GRCh38.bed.gz")
d=fread("COLO-asm/stats/PS00357_DSA.asm.phased.bed.gz")
hg = bind_rows(list(BL=a, BL_DSA=b, T=c, T_DSA=d), .id="ID") %>%
    mutate(
        mismatches_per_1000bp = 1000 * mismatches / (reference_end-reference_start),
        is_dsa = grepl("DSA", ID),
        is_T = grepl("T", ID),
    )
hg
```

```{r}
shg = hg %>%  
    group_by(ID, is_dsa, is_T) %>%

    summarise(
        mismatches=sum(mismatches),
        matches=sum(matches),
        total_bp = sum(query_length),
        ref_bp = sum(reference_end - reference_start),
        read_count = n(),
    ) %>%
    mutate(
        mismatches_per_1000bp = 1000 * mismatches / ref_bp,
    )
shg
z=shg %>%
    select(ID, is_dsa, mismatches_per_1000bp, is_T) %>%
    pivot_longer(cols=-c("ID","is_dsa", "is_T")) %>%
    ggplot(aes(x=ID, y=value, fill=is_dsa)) +
    geom_bar(stat="identity") +
    geom_label_repel(
        aes(label=comma(value)), 
        fill="white",
        direction="y",
        #vjust=-0.25
    ) +
    scale_y_continuous(
        "Mismatches per 1,000 bp of read sequence",

        #trans="log10",
    ) +
    scale_fill_manual("",
        labels=c("GRCh38", "DSA"),
        values=c("darkred", "skyblue"),
    ) +
    theme_minimal_grid() +

    #facet_col(~name, scales="free")+
    facet_row(~is_T, scales="free_x") + 
    theme(
        legend.position="top",
    )
my_ggsave("Figures/COLO-asm-mismatch.pdf")
```

```{r}
z=hg %>% 
    filter(!is_T) %>%
    group_by(ID) %>%
    sample_n(1e6) %>%
    mutate(
        x=1000*mismatches/(reference_end-reference_start),
        case = case_when(
            x == 0 ~ 0,
            x >0 & x <= 10  ~ 10,
            TRUE ~ Inf,
        )
    ) %>%
    ggplot(
        aes(
            x=x+0.01,
            #color=is_dsa,
            fill=is_dsa,
            group=ID,
        )
    ) +
    #geom_density(adjust=0.75) +
    geom_histogram(bins=30, position="identity", alpha=0.75)+
    scale_x_continuous(
        "Mismatches per 1,000 bp",
        #trans=scales::pseudo_log_trans(base = 10),
        trans="log10",
        label=comma,
    ) +
    scale_y_continuous(
        #trans="log10",
        label=comma,
    ) +
    #annotation_logticks(sides="b") +
    scale_fill_manual("",
        labels=c("GRCh38", "DSA"),
        values=c("darkred", "skyblue"),
    ) +
    #facet_col(~is_T) + 
    facet_row(~case, scales="free") + force_panelsizes(cols=c(1,6,6))+
    #facet_zoom(xlim=c(0,10)) +
    theme_minimal_grid() +
    theme(legend.position="top")
my_ggsave("Figures/COLO-asm-mismatch-density.pdf", height=4, width=6)
```




#
# do hap specific peaks in BL change in Tumor
#

# data
```{r}
colo_hap_peaks = my_read_bed("results/PS00338_COLO829BL_1/hap1-vs-hap2/FIRE.hap.differences.bed") %>%
    filter(p_adjust <= 0.05) 
colo_t_peaks = my_read_bed("results/PS00357_COLO829T_1/FDR-peaks/FDR-FIRE-peaks.bed.gz") 

#colo_tumor_track = my_read_bed("results/PS00357_COLO829T_1/FDR-peaks/FDR.track.bed.gz") %>%
 #   filter(coverage > 0, coverage_H1 > 0, coverage_H2>0) 

colo_hap_peaks %>%
    bed_map(colo_t_peaks,
        t_peak = n() > 0,
    ) %>%
    replace_na(list(t_peak=FALSE)) %>%
    filter(t_peak) 
```

# intersection + analysis
```{r}
#tumor_cov = mean(colo_tumor_track$coverage)
min_hap_cov = 10
filtered_colo_tumor_track = colo_t_peaks %>%
    filter(coverage_H1 > min_hap_cov, coverage_H2 > min_hap_cov) %>%
    mutate(
        hap1_per = fire_coverage_H1/coverage_H1,
        hap2_per = fire_coverage_H2/coverage_H2,
        diff = hap1_per - hap2_per, 
    ) 
sum(is.na(filtered_colo_tumor_track$diff))

colo_compare_df = colo_hap_peaks %>%
    bed_map(
        filtered_colo_tumor_track, 
        tumor_diff = diff[which.max(abs(diff))],
    ) %>%
    bed_map(
        imprinted, 
        is_imprinted = n()>0,
    ) %>%
    replace_na(list(is_imprinted=FALSE)) %>%
    filter(!is.na(tumor_diff)) %>%
    data.table()

asdf = colo_compare_df %>%
    select(chrom, start, end, diff, tumor_diff, is_imprinted) %>%
    mutate(
        diff_diffs = abs(diff - tumor_diff),
        large_t_diff = diff_diffs > 0.75,
    ) %>%
    ggplot(aes(x=diff, y=tumor_diff, color=is_imprinted)) +
    geom_abline(slope=1, intercept=0, color="red", linetype="dashed") +
    geom_abline(slope=1, intercept=-0.25, color="gray", linetype="dashed") +
    geom_abline(slope=1, intercept=0.25, color="gray", linetype="dashed") +
    geom_point(alpha=0.75, size=0.5) +
    geom_smooth(method="lm", se=FALSE, alpha=0.1, linewidth=0.1) +
    geom_text_repel(
        data = . %>% filter(large_t_diff),
        aes(
            label=paste0(chrom, ":", start, "-", end),
        ),
        size = 1,
        min.segment.length = 0,
    ) + 
    stat_cor(size=2) + 
    scale_y_continuous(
        "Percent accessibility difference in tumor peaks\n(filtered for peaks with 10x coverage in both haplotypes)",
        limits=c(-1,1), labels=percent) +
    scale_x_continuous(
        "Percent accessibility difference in blood haplotype-specific peaks",
        limits=c(-1,1), labels=percent) +
    scale_color_manual(
        "Imprinted",
        values=c("black", "darkorange"),
    )+
    # force equal aspect ratio
    coord_fixed() +
    theme_minimal_grid(font_size=6) +
    theme(legend.position="top")
my_ggsave("Figures/COLO-BL-Tumor-hap-peaks.pdf", height=3, width=3)
```
